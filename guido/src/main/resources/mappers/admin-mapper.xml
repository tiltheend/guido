<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.guido.admin.model.dao.AdminMapper">
	
	<!-- Event DTO에 대한 resultMap -->
	<resultMap type="Event" id="event_list_rm">
		<id property="eventNo" column="EVENT_NO"/>
		<result property="eventName" column="EVENT_NAME"/>
		<result property="eventContent" column="EVENT_CONTENT"/>
		<result property="eventEndDt" column="EVENT_END_DT"/>
		<result property="createDt" column="CREATE_DT"/>
		<result property="state" column="EVENT_STATE"/>
	</resultMap>
	
	<resultMap type="Event" id="event_rm">
		<id property="eventNo" column="EVENT_NO"/>
		<result property="eventName" column="EVENT_NAME"/>
		<result property="eventContent" column="EVENT_CONTENT"/>
		<result property="eventEndDt" column="EVENT_END_DT"/>
		<result property="createDt" column="CREATE_DT"/>
		<result property="state" column="EVENT_STATE"/>
		<result property="bgColor" column="BG_COLOR"/>
		<result property="mainBannerOrder" column="MAIN_BANNER_ORDER"/>
		<collection property="fileList"
					select="selectFileList"
					column="EVENT_NO"
					javaType="java.util.ArrayList"
					ofType="File"/>
	</resultMap>
	
	<resultMap type="File" id="file_rm">
		<id property="fileNo" column="FILE_NO"/>
		<result property="productNo" column="PRODUCT_NO"/>
		<result property="eventNo" column="EVENT_NO"/>
		<result property="qnaNo" column="QNA_NO"/>
		<result property="fileOrder" column="FILE_ORDER"/>
		<result property="filePath" column="FILE_PATH"/>
	</resultMap>
	
	<resultMap type="User" id="user_rm">
		<id property="userNo" column="USER_NO"/>
		<result property="userEmail" column="USER_EMAIL" />
		<result property="passportNo" column="PASSPORT_NO" />
		<result property="createDate" column="CREATE_DT" />
		<result property="userState" column="USER_STATE" />
		<result property="superGuideFl" column="SUPER_GUIDE_FL" />
	</resultMap>
	
	<resultMap id="product_rm" type="Product">
		<id property="productNo" column="PRODUCT_NO"/>
		<result property="productName" column="PRODUCT_NAME"/>
		<result property="productPackage" column="PRODUCT_PACKAGE"/>
		<result property="productContent" column="PRODUCT_CONTENT"/>
		<result property="tourDuration" column="TOUR_DURATION"/>
		<result property="productPrice" column="PRODUCT_PRICE"/>
		<result property="productAddPrice" column="PRODUCT_ADD_PRICE"/>
		<result property="maxTourist" column="PRODUCT_MAX_TOURIST"/>
		<result property="minTourist" column="PRODUCT_MIN_TOURIST"/>
		
		<result property="userNo" column="USER_NO"/>
		<result property="themeCode" column="THEME_CODE"/>
		<result property="productState" column="PRODUCT_STATE"/>
		<result property="createDate" column="CREATE_DT"/>
		<result property="guideLanguage" column="GUIDE_LANGUAGE"/>
		<result property="viewCount" column="VIEW_COUNT"/>
	</resultMap>
	
	<resultMap id="qna_rm" type="QNA">
		<id property="qnaNo" column="QNA_NO"/>
		<result property="qnaEmail" column="QNA_EMAIL"/>
		<result property="qnaTitle" column="QNA_TITLE"/>
		<result property="qnaContent" column="QNA_CONTENT"/>
		<result property="qnaDeleteFL" column="QNA_DEL_FL"/>
		<result property="qnaCheckFL" column="QNA_CHECK_FL"/>
		<result property="userNo" column="USER_NO"/>
		<result property="qnaAnswer" column="QNA_ANSWER"/>
		<result property="qnaDate" column="QNA_DATE" />
		
		<collection property="fileList"
					select="selectQnaFileList"
					column="QNA_NO"
					javaType="java.util.ArrayList"
					ofType="File"/>
	</resultMap>
	
	
	
	<select id="getListCount" resultType="_int">
		SELECT COUNT(*) FROM
		<choose>
			<when test="pageName == 'eventList'">
				"EVENT"
				<if test="query != null">WHERE EVENT_NAME LIKE '%${query}%' OR EVENT_CONTENT LIKE '%${query}%'</if>
			</when>
			<when test="pageName == 'touristManagement'">
				"USER" WHERE USER_TYPE='T'
			</when>
			<when test="pageName == 'guideManagement'">
				"USER" WHERE USER_TYPE='G'
			</when>
			<when test="pageName == 'guideApprovalRequest'">
				"USER" WHERE USER_TYPE='G' AND USER_STATE='Y'
			</when>
			<when test="pageName == 'productManagement'">
				"PRODUCT"
			</when>
			<when test="pageName == 'qna'">
				"QNA"
				<if test="query != null">WHERE QNA_TITLE LIKE '%${query}%' OR QNA_CONTENT LIKE '%${query}%'</if>
			</when>
		</choose>
	</select>
	
	<select id="selectList" resultType="map">
		SELECT
		<choose>
			<when test="pageName == 'eventList'">
				EVENT_NO, EVENT_NAME, TO_CHAR(CREATE_DT, 'YYYY-MM-DD') CREATE_DT, TO_CHAR(EVENT_END_DT, 'YYYY-MM-DD') EVENT_END_DT, EVENT_STATE, BG_COLOR, NVL2(MAIN_BANNER_ORDER,MAIN_BANNER_ORDER,'0') MAIN_BANNER_ORDER
				FROM EVENT
				<if test="query != null">WHERE EVENT_NAME LIKE '%${query}%' OR EVENT_CONTENT LIKE '%${query}%'</if>
				ORDER BY EVENT_NO DESC
			</when>
			<when test="pageName == 'touristManagement'">
				USER_NO, USER_EMAIL, PASSPORT_NO, TO_CHAR(CREATE_DT, 'YYYY-MM-DD') CREATE_DT, USER_STATE
				FROM "USER"
				NATURAL JOIN "TOURIST"
				WHERE USER_TYPE='T'
				ORDER BY USER_NO DESC
			</when>
			<when test="pageName == 'guideManagement'">
				USER_NO, USER_EMAIL, TO_CHAR(CREATE_DT, 'YYYY-MM-DD') CREATE_DT, USER_STATE, SUPER_GUIDE_FL 
				FROM "USER"
				NATURAL JOIN "GUIDE"
				WHERE USER_TYPE='G'
				ORDER BY USER_NO DESC
			</when>
			<when test="pageName == 'guideApprovalRequest'">
				USER_NO, USER_EMAIL, TO_CHAR(CREATE_DT, 'YYYY-MM-DD') CREATE_DT, CONFIRMATION_NO
				FROM "USER"
				NATURAL JOIN "GUIDE"
				WHERE USER_TYPE='G'
				AND USER_STATE='Y'
				ORDER BY USER_NO ASC
			</when>
			<when test="pageName == 'productManagement'">
				PRODUCT_NO, USER_EMAIL, PRODUCT_NAME, TO_CHAR(P.CREATE_DT, 'YYYY-MM-DD') CREATE_DT, PRODUCT_STATE FROM "PRODUCT" P
				JOIN "USER" USING(USER_NO)
				ORDER BY PRODUCT_NO DESC
			</when>
			<when test="pageName == 'qna'">
				QNA_NO, QNA_TITLE, QNA_EMAIL, QNA_DATE, QNA_CHECK_FL
				FROM QNA
				<if test="query != null">WHERE QNA_TITLE LIKE '%${query}%' OR QNA_CONTENT LIKE '%${query}%'</if>
				ORDER BY QNA_CHECK_FL, QNA_NO
			</when>
		</choose>
	</select>
	
	
	
	<select id="selectEvent" resultMap="event_rm">
		SELECT EVENT_NO, EVENT_NAME, EVENT_CONTENT, TO_CHAR(CREATE_DT,'YYYY"년" MM"월" DD"일" HH24"시" MI"분" SS"초"') CREATE_DT
		FROM EVENT
		WHERE EVENT_NO=#{eventNo}
	</select>
	
	<select id="selectFileList" resultMap="file_rm">
		SELECT FILE_ORDER, FILE_PATH FROM "FILE"
		WHERE EVENT_NO = #{eventNo}
		ORDER BY FILE_ORDER
	</select>
	
	<insert id="insertEvent">
		<selectKey order="BEFORE" resultType="_int" keyProperty="eventNo">
			SELECT SEQ_EVENT_NO.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO "EVENT" VALUES(#{eventNo}, #{eventName}, #{eventContent}, #{eventEndDt}, SYSDATE, DEFAULT,
			#{bgColor}, NULL
		)
	</insert>
	
	<insert id="insertFileList">
		INSERT INTO "FILE" (FILE_NO, EVENT_NO, FILE_ORDER, FILE_PATH)
		SELECT SEQ_FILE_NO.NEXTVAL, A.*
		FROM (
		  <foreach collection="list" item="file" separator=" UNION ALL ">
		    SELECT #{file.eventNo} EVENT_NO, #{file.fileOrder} FILE_ORDER, #{file.filePath} FILE_PATH FROM DUAL
		  </foreach>
		) A
	</insert>
	
	<select id="selectQNA" resultMap="qna_rm">
		SELECT * FROM QNA WHERE QNA_NO=#{qnaNo}
	</select>
	
	<select id="selectQnaFileList" resultMap="file_rm">
		SELECT FILE_ORDER, FILE_PATH FROM "FILE"
		WHERE QNA_NO = #{qnaNo}
		ORDER BY FILE_ORDER 
	</select>
	
	<update id="writeAnswer">
		UPDATE QNA SET QNA_ANSWER = #{qnaAnswer}, QNA_CHECK_FL = 'Y' WHERE QNA_NO = #{qnaNo}
	</update>
	
	<update id="approveGuide" parameterType="java.util.List">
	  UPDATE "USER" SET USER_STATE='N' WHERE USER_STATE='Y' AND USER_NO IN
	  <foreach item="userNo" collection="list" open="(" separator="," close=")">#{userNo}</foreach>
	</update>
	
	<select id="selectMainEventList" resultType="map">
		<![CDATA[  
		SELECT NVL("EVENT".EVENT_NO, 0) AS EVENT_NO,
        DUMMY_MAIN_BANNER_ORDER AS MAIN_BANNER_ORDER,
		       NVL2(BG_COLOR, BG_COLOR, '#ffffff') AS BG_COLOR,
		       FILE_PATH
		FROM (
		    SELECT LEVEL AS DUMMY_MAIN_BANNER_ORDER
		    FROM DUAL
		    CONNECT BY LEVEL <= 8
		) DUMMY_SEQ
		LEFT JOIN "EVENT" ON DUMMY_MAIN_BANNER_ORDER = MAIN_BANNER_ORDER
		LEFT JOIN "FILE" ON "EVENT".EVENT_NO = "FILE".EVENT_NO AND FILE_ORDER = 0
		ORDER BY MAIN_BANNER_ORDER
		]]>
	</select>
	
	<update id="deleteMainBanner">
		UPDATE "EVENT" SET MAIN_BANNER_ORDER = NULL WHERE MAIN_BANNER_ORDER = #{order}
	</update>
	
	
	<update id="setMainBanner">
		UPDATE "EVENT" SET MAIN_BANNER_ORDER = #{order} WHERE EVENT_NO = #{eventNo}
	</update>
	
	
	<update id="eventBlind" parameterType="java.util.List">
	  UPDATE "EVENT" SET EVENT_STATE='B', MAIN_BANNER_ORDER=NULL WHERE EVENT_NO IN
	  <foreach item="eventNo" collection="list" open="(" separator="," close=")">#{eventNo}</foreach>
	</update>
	
	<update id="eventBlindCancel" parameterType="java.util.List">
	  UPDATE "EVENT" SET EVENT_STATE='N' WHERE EVENT_NO IN
	  <foreach item="eventNo" collection="list" open="(" separator="," close=")">#{eventNo}</foreach>
	</update>
	
</mapper>