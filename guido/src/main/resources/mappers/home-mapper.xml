<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.guido.home.model.dao.HomeMapper">

	<!-- Product resultMap-->
	<resultMap type="Product" id="product_rm">
		<id property="productNo" column="PRODUCT_NO" />

		<result property="productName" column="PRODUCT_NAME" />
		<result property="productPackage" column="PRODUCT_PACKAGE" />
		<result property="productContent" column="PRODUCT_CONTENT" />
		<result property="productPrice" column="PRODUCT_PRICE" />
		<result property="productAddPrice" column="PRODUCT_ADD_PRICE" />
		<result property="maxTourist" column="PRODUCT_MAX_TOURIST" />
		<result property="minTourist" column="PRODUCT_MIN_TOURIST" />
		
		<result property="userNo" column="USER_NO" />
		<result property="themeCode" column="THEME_CODE" />
		<result property="productState" column="PRODUCT_STATE" />
		<result property="createDate" column="CREATE_DT" />
		<result property="guideLanguage" column="GUIDE_LANGUAGE" />
		<result property="viewCount" column="VIEW_COUNT" />
		
		<result property="regionName" column="REGION_NAME" />
		<result property="themeName" column="THEME_NAME" />
		
		<result property="reviewStars" column="REVIEW_STARS" />
		<result property="superGuideFl" column="SUPER_GUIDE_FL" />
		
		<collection property="imageList" select="selectImageList"
			column="PRODUCT_NO" javaType="java.util.ArrayList" ofType="File"/>
	</resultMap>
	
	
	<resultMap  type="File" id="file_rm">
		<id property="fileNo" column="FILE_NO" />
	 	<result property="productNo" column="PRODUCT_NO" />
	 	<result property="fileOrder" column="FILE_ORDER" />
	 	<result property="filePath" column="FILE_PATH" />
	</resultMap>


	<!-- 테마 종류 조회 -->
	<select id="selectThemeTypeList" resultType="map">
		SELECT * FROM THEME ORDER BY 1
	</select>


	<!-- 특정 테마의 삭제되지 않은 상품 수 조회 -->
	<!--<select id="getListCount" resultType="int">
		SELECT COUNT(*) FROM PRODUCT
		WHERE PRODUCT_STATE = 'D'
	</select>-->

	<!-- 상품 목록 조회 -->
	<select id="selectProductList" resultMap="product_rm">
	  <![CDATA[
	    SELECT *
	    FROM (
	      SELECT ROWNUM, P.PRODUCT_NO, P.PRODUCT_NAME, P.PRODUCT_PRICE, P.REGION_NAME,
	             (SELECT NVL(TO_CHAR(AVG(REVIEW_STARS), 'FM9.09'), '0.0')
	              FROM REVIEW
	              WHERE PRODUCT_NO = P.PRODUCT_NO) AS REVIEW_STARS
	      FROM PRODUCT P
	      WHERE P.PRODUCT_STATE = 'N'
	      ORDER BY P.CREATE_DT DESC
	    )
	    WHERE ROWNUM <= 16
	  ]]>
	</select>
	
	 <!-- 특정 상품 이미지 목록 조회 -->
	 <select id="selectImageList" resultMap="file_rm">
		 SELECT * FROM "FILE"
		WHERE PRODUCT_NO = #{productNo}
		ORDER BY FILE_ORDER
	 </select>

	<!-- ********** 인기 여행지 목록 조회 ********** -->
	<select id="selectPopularProductList" resultMap="product_rm">
	  <![CDATA[
	    SELECT *
	    FROM (
	      SELECT ROWNUM, P.PRODUCT_NO, P.PRODUCT_NAME, P.PRODUCT_PRICE, P.REGION_NAME,
	             (SELECT NVL(TO_CHAR(AVG(REVIEW_STARS), 'FM9.09'), '0.0')
	              FROM REVIEW
	              WHERE PRODUCT_NO = P.PRODUCT_NO) AS REVIEW_STARS
	      FROM PRODUCT P
	      WHERE P.PRODUCT_STATE = 'N'
	      ORDER BY P.CREATE_DT DESC
	    )
	    WHERE ROWNUM <= 8
	  ]]>
	</select>

	<!-- 슈퍼가이드 상품 목록 조회 -->
	<select id="selectSuperProductList" resultMap="product_rm">
	  <![CDATA[
		SELECT *
		FROM (
		    SELECT P.PRODUCT_NO, P.PRODUCT_NAME, P.PRODUCT_PRICE, P.REGION_NAME, G.SUPER_GUIDE_FL, 
		           (SELECT NVL(TO_CHAR(AVG(REVIEW_STARS), 'FM9.09'), '0.0') 
		            FROM REVIEW 
		            WHERE PRODUCT_NO = P.PRODUCT_NO) AS REVIEW_STARS
		    FROM PRODUCT P
		    JOIN GUIDE G ON P.USER_NO = G.USER_NO
		    WHERE P.PRODUCT_STATE = 'N' AND G.SUPER_GUIDE_FL = 'Y'
		    ORDER BY REVIEW_STARS DESC
		)
		WHERE ROWNUM <= 8
	  ]]>
	</select>

	<!-- ********** 추천 상품 목록 조회 ********** -->
	<select id="selectRecommProductList" resultMap="product_rm">
	  <![CDATA[
	    SELECT *
	    FROM (
	      SELECT ROWNUM, P.PRODUCT_NO, P.PRODUCT_NAME, P.PRODUCT_PRICE, P.REGION_NAME,
	             (SELECT NVL(TO_CHAR(AVG(REVIEW_STARS), 'FM9.09'), '0.0')
	              FROM REVIEW
	              WHERE PRODUCT_NO = P.PRODUCT_NO) AS REVIEW_STARS
	      FROM PRODUCT P
	      WHERE P.PRODUCT_STATE = 'N'
	      ORDER BY P.CREATE_DT DESC
	    )
	    WHERE ROWNUM <= 8
	  ]]>
	</select>

</mapper>